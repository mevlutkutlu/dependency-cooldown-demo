name: dependency-cooldown

on:
  pull_request:
    paths:
      - 'package.json'
      - 'package-lock.json'

jobs:
  cooldown:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enforce dependency cooldown (Node script)
        env:
          COOLDOWN_DAYS: "7"
        run: |
          node <<'NODE'
          const fs = require("fs");
          const { execSync } = require("child_process");

          const cooldownDays = Number(process.env.COOLDOWN_DAYS || "3");
          const maxAgeMs = cooldownDays * 24 * 60 * 60 * 1000;
          const now = Date.now();

          const pkg = JSON.parse(fs.readFileSync("package.json", "utf8"));
          const deps = pkg.dependencies || {};

          if (!Object.keys(deps).length) {
            console.log("No dependencies found in package.json");
            process.exit(0);
          }

          let tooNew = false;

          console.log(`Checking dependencies… (cooldown: ${cooldownDays} days)`);

          for (const [name, version] of Object.entries(deps)) {
            const cleanVersion = version.replace(/^[~^]/, "");
            console.log(`Checking ${name}@${cleanVersion} …`);

            try {
              // npm view <name> time --json  => { "1.0.0": "...", "1.1.0": "...", ... }
              const out = execSync(`npm view ${name} time --json`, {
                encoding: "utf8",
                stdio: ["ignore", "pipe", "pipe"],
              });

              const times = JSON.parse(out);
              const iso = times[cleanVersion];

              if (!iso) {
                console.log(`::warning::No publish time found for ${name}@${cleanVersion}, skipping`);
                continue;
              }

              const published = new Date(iso).getTime();
              if (Number.isNaN(published)) {
                console.log(`::warning::Invalid date for ${name}@${cleanVersion}: ${iso}`);
                continue;
              }

              const ageMs = now - published;
              const ageDays = Math.floor(ageMs / 86400000);

              if (ageMs < maxAgeMs) {
                console.log(`::error::${name}@${cleanVersion} is too new (age: ${ageDays} days, needs >= ${cooldownDays})`);
                tooNew = true;
              } else {
                console.log(`${name}@${cleanVersion} is old enough (age: ${ageDays} days).`);
              }
            } catch (err) {
              console.log(`::warning::Failed to check ${name}@${cleanVersion}: ${err.message}`);
            }
          }

          if (tooNew) {
            console.log("Some dependencies are still in cooldown.");
            process.exitCode = 1;
          } else {
            console.log("All dependencies passed cooldown check.");
          }
          NODE
